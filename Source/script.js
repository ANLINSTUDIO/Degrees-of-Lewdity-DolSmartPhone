window.PhoneMod = window.PhoneMod || {};

PhoneMod.PhoneGameQuestions = {
  "Maths": [
    {
      "q": "若一个等差数列的首项为3，公差为4，则第10项是多少？",
      "a": "39",
      "w": ["43", "36", "40", "35", "42", "37", "41", "38", "44", "45"]
    },
    {
      "q": "在平面直角坐标系中，点(3, -4)到原点的距离是多少？",
      "a": "5",
      "w": ["7", "1", "25", "12", "4", "3", "√7", "√14", "6", "8"]
    },
    {
      "q": "函数 y = sin(x) 的最小正周期是多少？",
      "a": "2π",
      "w": ["π", "π/2", "4π", "3π", "2", "3.14", "1", "0", "π/4", "1.5π"]
    },
    {
      "q": "已知集合A={1,2,3}，B={2,3,4}，则A与B的交集是什么？",
      "a": "{2, 3}",
      "w": ["{1, 4}", "{1, 2, 3, 4}", "{2}", "{3}", "{ }", "{1}", "{4}", "{1, 2}", "{3, 4}", "{1, 3}"]
    },
    {
      "q": "抛掷两枚质地均匀的硬币，两枚都是正面向上的概率是多少？",
      "a": "1/4",
      "w": ["1/2", "1/3", "1/8", "2/3", "3/4", "1", "0", "1/6", "1/5", "2/5"]
    },
    {
      "q": "黄金分割比例（近似值）是多少？",
      "a": "0.618",
      "w": ["0.314", "0.732", "0.5", "0.8", "0.666", "0.414", "0.577", "0.707", "0.866", "0.912"]
    },
    {
      "q": "一个圆柱的底面半径为1，高为2，它的体积是多少？",
      "a": "2π",
      "w": ["π", "4π", "2", "4", "3π", "π/2", "1", "6", "8", "1.5π"]
    },
    {
      "q": "log10(1000) 的值是多少？",
      "a": "3",
      "w": ["2", "10", "100", "1", "0", "30", "5", "4", "1.5", "2.5"]
    },
    {
      "q": "三角形三内角之和在欧几里得几何中是多少度？",
      "a": "180°",
      "w": ["90°", "360°", "270°", "100°", "120°", "150°", "200°", "170°", "300°", "540°"]
    },
    {
      "q": "求导：f(x) = x²，则 f'(x) 是多少？",
      "a": "2x",
      "w": ["x", "2", "x²", "1", "0", "x³", "1/2 x", "2x²", "3x", "x/2"]
    }
  ],
  "History": [
    {
      "q": "中国历史上第一个大一统的封建王朝是？",
      "a": "秦朝",
      "w": ["汉朝", "唐朝", "周朝", "夏朝", "商朝", "宋朝", "明朝", "清朝", "隋朝", "元朝"]
    },
    {
      "q": "《马关条约》是在哪场战争后签订的？",
      "a": "甲午中日战争",
      "w": ["鸦片战争", "第二次鸦片战争", "八国联军侵华", "中法战争", "抗日战争", "抗美援朝", "军阀混战", "辛亥革命", "太平天国", "普法战争"]
    },
    {
      "q": "被誉为“欧洲文艺复兴发源地”的城市是？",
      "a": "佛罗伦萨",
      "w": ["罗马", "巴黎", "伦敦", "威尼斯", "米兰", "雅典", "马德里", "柏林", "维也纳", "那不勒斯"]
    },
    {
      "q": "提出“我思故我在”的著名哲学家是？",
      "a": "笛卡尔",
      "w": ["苏格拉底", "柏拉图", "亚里士多德", "康德", "黑格尔", "尼采", "卢梭", "伏尔泰", "孟德斯鸠", "培根"]
    },
    {
      "q": "中国科举制度正式废除是在哪一年？",
      "a": "1905年",
      "w": ["1900年", "1911年", "1898年", "1912年", "1919年", "1921年", "1840年", "1860年", "1908年", "1903年"]
    },
    {
      "q": "“工业革命”最早起源于哪个国家？",
      "a": "英国",
      "w": ["美国", "法国", "德国", "中国", "荷兰", "意大利", "日本", "俄国", "西班牙", "比利时"]
    },
    {
      "q": "签署《独立宣言》标志着哪个国家诞生？",
      "a": "美国",
      "w": ["法国", "英国", "加拿大", "澳大利亚", "德国", "巴西", "阿根廷", "墨西哥", "印度", "南非"]
    },
    {
      "q": "成吉思汗的本名是？",
      "a": "铁木真",
      "w": ["忽必烈", "托雷", "窝阔台", "术赤", "察合台", "努尔哈赤", "皇太极", "多尔衮", "冒顿", "完颜阿骨打"]
    },
    {
      "q": "“贞观之治”是指哪位皇帝在位期间的统治？",
      "a": "唐太宗",
      "w": ["唐玄宗", "唐高祖", "汉武帝", "汉高祖", "秦始皇", "明太祖", "康熙帝", "乾隆帝", "隋文帝", "武则天"]
    },
    {
      "q": "第一次世界大战的导火索是？",
      "a": "萨拉热窝事件",
      "w": ["珍珠港事件", "波士顿倾茶事件", "滑铁卢战役", "凡尔登战役", "慕尼黑阴谋", "诺曼底登陆", "斯大林格勒保卫战", "卢沟桥事变", "中途岛海战", "敦刻尔克大撤退"]
    }
  ],
  "English": [
    {
      "q": "“采菊东篱下，悠然见南山”是谁的诗句？",
      "a": "陶渊明",
      "w": ["李白", "杜甫", "白居易", "王维", "谢灵运", "苏轼", "辛弃疾", "李商隐", "杜牧", "孟浩然"]
    },
    {
      "q": "《三国演义》中，“过五关斩六将”的是谁？",
      "a": "关羽",
      "w": ["张飞", "赵云", "马超", "诸葛亮", "刘备", "吕布", "曹操", "孙权", "黄忠", "魏延"]
    },
    {
      "q": "成语“闻鸡起舞”的主人公是谁？",
      "a": "祖逖",
      "w": ["勾践", "项羽", "刘邦", "匡衡", "廉颇", "蔺相如", "苏秦", "张仪", "韩信", "岳飞"]
    },
    {
      "q": "下列哪个不属于“岁寒三友”？",
      "a": "菊",
      "w": ["松", "竹", "梅", "兰", "荷", "柳", "柏", "枫", "桃", "杏"]
    },
    {
      "q": "《红楼梦》中，葬花的人是？",
      "a": "林黛玉",
      "w": ["薛宝钗", "王熙凤", "贾元春", "史湘云", "贾探春", "晴雯", "袭人", "妙玉", "贾巧姐", "秦可卿"]
    },
    {
      "q": "“出淤泥而不染”赞美的是什么植物？",
      "a": "莲花",
      "w": ["梅花", "兰花", "菊花", "牡丹", "玫瑰", "水仙", "桂花", "桃花", "杜鹃", "海棠"]
    },
    {
      "q": "被称为“诗仙”的是？",
      "a": "李白",
      "w": ["杜甫", "王维", "白居易", "李贺", "李商隐", "苏轼", "贺知章", "孟浩然", "柳宗元", "刘禹锡"]
    },
    {
      "q": "成语“破釜沉舟”与哪场战役有关？",
      "a": "巨鹿之战",
      "w": ["官渡之战", "赤壁之战", "淝水之战", "长平之战", "牧野之战", "城濮之战", "夷陵之战", "虎牢关之战", "土木堡之变", "崖门海战"]
    },
    {
      "q": "《师说》的作者是？",
      "a": "韩愈",
      "w": ["柳宗元", "欧阳修", "苏轼", "曾巩", "王安石", "苏洵", "苏辙", "范仲淹", "司马光", "陆游"]
    },
    {
      "q": "“路漫漫其修远兮，吾将上下而求索”出自？",
      "a": "《离骚》",
      "w": ["《诗经》", "《论语》", "《九歌》", "《天问》", "《孟子》", "《史记》", "《左传》", "《战国策》", "《庄子》", "《老子》"]
    }
  ],
  "Science": [
    {
      "q": "地球大气中含量最高的气体是？",
      "a": "氮气",
      "w": ["氧气", "二氧化碳", "氩气", "氢气", "氦气", "臭氧", "一氧化碳", "甲烷", "水蒸气", "氖气"]
    },
    {
      "q": "被誉为“细胞的能量工厂”的是？",
      "a": "线粒体",
      "w": ["叶绿体", "细胞核", "高尔基体", "核糖体", "溶酶体", "内质网", "液泡", "细胞膜", "中心体", "细胞质"]
    },
    {
      "q": "光在真空中传播的速度约为多少？",
      "a": "30万公里/秒",
      "w": ["340米/秒", "15万公里/秒", "100万公里/秒", "3万公里/秒", "10万公里/秒", "50万公里/秒", "20万公里/秒", "80万公里/秒", "1亿米/秒", "5万公里/秒"]
    },
    {
      "q": "人体最大的器官是？",
      "a": "皮肤",
      "w": ["肝脏", "大脑", "肺", "小肠", "心脏", "肾脏", "胃", "脾脏", "大肠", "骨骼"]
    },
    {
      "q": "下列哪个属于化学变化？",
      "a": "铁生锈",
      "w": ["水结冰", "酒精挥发", "盐溶解", "玻璃破碎", "电灯发光", "干冰升华", "切水果", "磁化", "折断木棒", "水沸腾"]
    },
    {
      "q": "太阳系中体积最大的行星是？",
      "a": "木星",
      "w": ["土星", "海王星", "天王星", "地球", "火星", "金星", "水星", "冥王星", "太阳", "月球"]
    },
    {
      "q": "pH值等于7的溶液呈什么性？",
      "a": "中性",
      "w": ["酸性", "碱性", "强酸性", "强碱性", "弱酸性", "弱碱性", "腐蚀性", "挥发性", "还原性", "氧化性"]
    },
    {
      "q": "万有引力定律是谁提出的？",
      "a": "牛顿",
      "w": ["爱因斯坦", "伽利略", "霍金", "法拉第", "居里夫人", "特斯拉", "普朗克", "波尔", "达尔文", "阿基米德"]
    },
    {
      "q": "声音在下列哪种介质中传播速度最快？",
      "a": "钢轨",
      "w": ["空气", "水", "真空", "软木", "酒精", "海水", "塑料", "棉花", "橡胶", "煤油"]
    },
    {
      "q": "缺碘会导致哪种疾病？",
      "a": "大脖子病",
      "w": ["夜盲症", "坏血病", "佝偻病", "贫血", "糖尿病", "高血压", "脚气病", "白化病", "色盲", "哮喘"]
    }
  ]
}
PhoneMod.events = [
  {passage: "Shopping Centre", target: "Supermarket", event: "Shopping Centre Phone Shop Link"},
  {passage: "School Lockers Sneak", target: "School Lockers", event: "School Lockers Sneak Phone", chance: 0.1, position: "before"},
  {passage: "Spa Work Cute", target: "Spa Tired Keep", event: "Spa Tired Steal Phone Text", chance: 1, position: "before", 
    replace_target: "Spa Tired Steal", replace_event: "Spa Tired Steal Phone Link"},
  {passage: "Spa Work Sophisticated", target: "Spa Tired Keep", event: "Spa Tired Steal Phone Text", chance: 1, position: "before", 
    replace_target: "Spa Tired Steal", replace_event: "Spa Tired Steal Phone Link"},
  {passage: "Spa Tired Work", target: "Spa Tired Keep", event: "Spa Tired Steal Phone Text", chance: 1, position: "before", 
    replace_target: "Spa Tired Steal", replace_event: "Spa Tired Steal Phone Link"},
  {passage: "Spa Tired Grope", target: "Spa Tired Keep", event: "Spa Tired Steal Phone Text", chance: 1, position: "before", 
    replace_target: "Spa Tired Steal", replace_event: "Spa Tired Steal Phone Link"},
  {passage: "Elk Street", target: "Dilapidated Shop", event: "Second Phone Shop Link"},
]
PhoneMod.phoneConditionLevels = [
    { threshold: 0.8, text: "崭新出厂", color: "#4CAF50" },
    { threshold: 0.6, text: "略有磨损", color: "#8BC34A" },
    { threshold: 0.4, text: " 明显划痕", color: "#FFC107" },
    { threshold: 0.2, text: "严重磨损", color: "#FF9800" },
    { threshold: 0, text: "残破不堪", color: "#F44336" }
];

function OnMacro(name, func) {
  let originalMacro = Macro.get(name);
    if (originalMacro) {
        let oldHandler = originalMacro.handler;
        Macro.delete(name);
        Macro.add(name, {
            handler: function () {
                oldHandler.apply(this, arguments);
                setTimeout(func, 50);
            }
        });
    }
}


// ===================== API =======================
// 获取当前时间的总分钟数（包括日期换算，用于精准闹钟对比）
PhoneMod.getAbsTime = function() {
    return {
        year: Time.date.year,
        day: Time.date.day,
        month: Time.date.month,
        weekDay: Time.date.weekDay,
        hour: Time.date.hour,
        minute: Time.date.minute
    };
};
PhoneMod.getTimeString = function() {
    if (typeof Time === 'undefined' || !Time.date) return "--:--";
    let h = Time.date.hour;
    let m = Time.date.minute;
    return h + ":" + (m < 10 ? "0" + m : m);
};
PhoneMod.getDateString = function() {
    if (typeof Time === 'undefined' || !Time.date) return "--------------";
    let m = Time.date.month;
    let d = Time.date.day;
    return Time.date.year + "-" + (m < 10 ? "0" + m : m) + "-" + (d < 10 ? "0" + d : d);
};
PhoneMod.shouldShowPhone = function() { // 在某些页面不应当可以操控手机
    if (typeof V === 'undefined') return false;
    if (V.combat === 1) return false;
    if (V.event !== undefined) return false;
    if (!V.passage) return false; 
    if (["Start", "Start2", "Main Menu", "Credits"].includes(passage())) return false;
    if (V.phoneReturnPassage) return false; 

    // 检查是否有可用的手机
    if (V.PhoneOwned) {
      for (var i = 0; i < V.PhoneOwned.length; i++) {
        if (V.PhoneOwned[i].usable) return true;
      }}
    return false;
    
};
PhoneMod.PhoneTo =  function() {
    if (!V.phoneReturnPassage) {
        V.phoneReturnPassage = passage()
    }
}
PhoneMod.getPhoneConditionInfo = function(condition) {
    condition = Math.max(0, Math.min(1, condition)); // 限制在0-1范围内
    for (let level of PhoneMod.phoneConditionLevels) {
        if (condition >= level.threshold) {
            return {
                text: level.text,
                color: level.color,
                value: condition,
                percentage: Math.round(condition * 100)
            };
        }
    }
    
    return {
        text: "看不出情况",
        color: "#9E9E9E",
        value: condition,
        percentage: Math.round(condition * 100)
    };
}


// =================== 操控手机 =====================
PhoneMod.togglePhone = function(forceOpen) {
    const phone = document.getElementById("smart-phone-container");
    if (!phone) return;
    if (forceOpen === true) {
        phone.classList.add("phone-open");
    } else {
        phone.classList.toggle("phone-open");
        if (V.phoneAlarmTriggered && !phone.classList.contains("phone-open")) PhoneMod.cancelAlarm();
    }
};
PhoneMod.toggleApp = function(AppName) {
    V.phoneApp = AppName;
    Engine.play(passage()); 
    PhoneMod.togglePhone(true);
};
$(document).on("keyup", function(event) { // 监听 Control 键
    if (event.key === "Control") {
        PhoneMod.togglePhone();
    }
});
PhoneMod.PhoneUIInit = function (ev) {
    if (!PhoneMod.shouldShowPhone()) return;

    PhoneMod.checkAlarms();

    const phoneUI = document.createElement('div');
    phoneUI.id = "phone-wrapper";
    $(ev.content).append(phoneUI);
    new Wikifier(phoneUI, "<<smartphone_render>>");
};


// ==================== 闹钟实现 ====================
PhoneMod.initAlarm = function() {
    setTimeout(() => {
        if (typeof Time === 'undefined' || !Time.date) {
            document.getElementById('phone-alarm-time').value = "00:00"
        } else {
            let h = Time.date.hour;
            let m = Time.date.minute;
            m += 1;
            if (m >= 60) {
                m = 0;
                h += 1;
                if (h >= 24) {
                    h = 0;
                }
            }
            document.getElementById('phone-alarm-time').value = (h < 10 ? "0" + h : h) + ":" + (m < 10 ? "0" + m : m)
        }

        PhoneMod.toggleAlarmType("today");

    }, 10);
};
PhoneMod.checkAlarms = function() { // 闹钟检查
    // 如果闹钟正在触发、未被关闭而切换了Passage，则仍然需要响铃
    if (V.phoneAlarmTriggered) {
        setTimeout(() => PhoneMod.togglePhone(true), 10);
    }
    
    if (!V.phoneAlarms || V.phoneAlarms.length === 0) return;
    let now = PhoneMod.getAbsTime();

    // 确保V.lastAlarmCheckTime存在
    if (!V.lastAlarmCheckTime) {
        V.lastAlarmCheckTime = {
            year: now.year,
            month: now.month,
            day: now.day,
            hour: now.hour,
            minute: now.minute
        };
    }

    // 遍历闹钟
    for (let i = 0; i < V.phoneAlarms.length; i++) {
        const alarm = V.phoneAlarms[i];
        if (!alarm.active) continue;
        
        let shouldTrigger = false;
        
        if (alarm.type === "once") {
            // 一次性闹钟：检查是否在V.lastAlarmCheckTime到now的时间段内
            const alarmDate = new Date(alarm.year, alarm.month - 1, alarm.day, alarm.hour, alarm.minute);
            const lastCheck = new Date(
                V.lastAlarmCheckTime.year, 
                V.lastAlarmCheckTime.month - 1, 
                V.lastAlarmCheckTime.day, 
                V.lastAlarmCheckTime.hour, 
                V.lastAlarmCheckTime.minute
            );
            const currentTime = new Date(now.year, now.month - 1, now.day, now.hour, now.minute);
            
            // 如果闹钟时间在上次检查时间和当前时间之间（包含边界）
            shouldTrigger = (alarmDate >= lastCheck && alarmDate <= currentTime);
            
        } else if (alarm.type === "weekly") {
            // 周期闹钟：需要检查是否跨越了周边界
            // 计算从上次检查到当前时间之间的所有闹钟时间
            const lastCheck = new Date(
                V.lastAlarmCheckTime.year, 
                V.lastAlarmCheckTime.month - 1, 
                V.lastAlarmCheckTime.day, 
                V.lastAlarmCheckTime.hour, 
                V.lastAlarmCheckTime.minute
            );
            const currentTime = new Date(now.year, now.month - 1, now.day, now.hour, now.minute);
            
            // 获取上次检查和当前时间的星期几
            const lastCheckWeekDay = lastCheck.getDay(); // 0-6, 0=周六
            const currentWeekDay = currentTime.getDay();
            
            // 计算从上次检查到当前时间经过了多少天
            const timeDiff = currentTime.getTime() - lastCheck.getTime();
            const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
            
            // 检查这段时间内是否有闹钟应该触发
            for (let dayOffset = 0; dayOffset <= daysDiff; dayOffset++) {
                const checkDate = new Date(lastCheck);
                checkDate.setDate(lastCheck.getDate() + dayOffset);
                let weekday = checkDate.getDay() + 1;
                if (weekday > 6) weekday = 0;
                
                // 如果这天是闹钟设定的星期几
                if (alarm.weekDays.contains(weekday)) {
                    // 创建这天的闹钟时间
                    const alarmDateTime = new Date(
                        checkDate.getFullYear(),
                        checkDate.getMonth(),
                        checkDate.getDate(),
                        alarm.hour,
                        alarm.minute
                    );
                    
                    // 检查这个闹钟时间是否在检查时间范围内
                    if (alarmDateTime >= lastCheck && alarmDateTime <= currentTime) {
                        shouldTrigger = true;
                        break;
                    }
                }
            }
        }
        
        if (shouldTrigger) {
            V.phoneAlarmTriggered = true;
            V.phoneAlarmCurrent = alarm;
            if (alarm.type === "once") alarm.active = false; // 一次性的关掉
            setTimeout(() => PhoneMod.togglePhone(true), 10);
        }
    }

    // 更新最后检查时间
    V.lastAlarmCheckTime = {
        year: now.year,
        month: now.month,
        day: now.day,
        hour: now.hour,
        minute: now.minute
    };
};
PhoneMod.cancelAlarm = function() { // 关闭闹钟
    V.phoneAlarmTriggered = false;
    V.phoneAlarmCurrent = undefined;
    Engine.play(passage()); 
};
PhoneMod.deleteAlarm = function(index) { // 删除闹钟
    V.phoneAlarms.pop(index);
    Engine.play(passage()); 
    PhoneMod.togglePhone(true);
};
PhoneMod.toggleAlarmType = function(type) {
    document.getElementById('weekly-input').style.display = 'none';
    document.getElementById('phone-alarm-date').style.display = 'none';
    if(type === 'date') {
        document.getElementById('phone-alarm-date-input').value = PhoneMod.getDateString();
        document.getElementById('phone-alarm-date').style.display = 'block';
    } else if(type === 'weekly') {
        document.querySelectorAll(`input[name="weekday"]`).forEach(checkbox => {
            if (parseInt(checkbox.value) === Time.date.weekDay) {
                checkbox.checked = "checked"
            } else {
                checkbox.checked = ""
            }
        });
        document.getElementById('weekly-input').style.display = 'block';
    }
}
PhoneMod.submitAlarm = function() {
    const t = document.getElementById('phone-alarm-time').value;
    const msg = document.getElementById('phone-alarm-msg').value;
    const alarmType = document.querySelector('input[name="alarm-type"]:checked').value;
    
    if(t) {
        const timeParts = t.split(':');
        if(!V.phoneAlarms) V.phoneAlarms = [];
        
        if(alarmType === 'date' | alarmType === 'today') {
            let d = "";
            if(alarmType === 'today') {
                d = PhoneMod.getDateString();
            } else {
                d = document.getElementById('phone-alarm-date-input').value; // YYYY-MM-DD
            };

            if(d) {
                const dateParts = d.split('-');
                V.phoneAlarms.push({
                    type: "once",
                    year: parseInt(dateParts[0]),  // 添加年份以便更精确
                    month: parseInt(dateParts[1]),
                    day: parseInt(dateParts[2]),
                    hour: parseInt(timeParts[0]),
                    minute: parseInt(timeParts[1]),
                    msg: msg,
                    active: true
                });
            }
        } else {
            // 星期模式
            const selectedWeekdays = [];
            document.querySelectorAll('input[name="weekday"]:checked').forEach(checkbox => {
                selectedWeekdays.push(parseInt(checkbox.value));
            });
            
            V.phoneAlarms.push({
                type: "weekly",
                weekDays: selectedWeekdays,
                hour: parseInt(timeParts[0]),
                minute: parseInt(timeParts[1]),
                msg: msg,
                active: true
            });
        }
    };
    PhoneMod.toggleApp('alarm')
}
PhoneMod.getAlarmDesc = function(alarm) {
    if (alarm.type === "once") {
        return `${alarm.year}-${alarm.month}-${alarm.day}`
    } else {
        const weekdays = ['周六', '周日', '周一', '周二', '周三', '周四', '周五'];
        return alarm.weekDays.map(day => weekdays[day]).join(' ');
    }
}
// ================== 手机游戏实现 ==================
PhoneMod.getGameQuestion = function(category) {
    const pool = PhoneMod.PhoneGameQuestions[category];
    const rawQ = pool[Math.floor(Math.random() * pool.length)];
    
    // 1. 从 10 个错误选项中随机抽 3 个
    let selectedWrongs = PhoneMod.shuffle([...rawQ.w]).slice(0, 3);
    
    // 2. 组合正确答案和抽出的错误答案
    let options = [
        { text: rawQ.a, isCorrect: true },
        ...selectedWrongs.map(text => ({ text: text, isCorrect: false }))
    ];
    
    // 3. 再次打乱这 4 个选项的显示顺序
    PhoneMod.shuffle(options);
    
    return {
        title: rawQ.q,
        options: options
    };
}
PhoneMod.shuffle = function(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}
// ==================== 设置实现 ====================
PhoneMod.handleWallpaperUpload = function(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    
    // 检查文件类型
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
        alert('不支持的文件格式！请上传 JPG, PNG, GIF 或 WebP 格式的图片。');
        input.value = ''; // 清空选择
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        // 保存到SugarCube变量
        V.wallpaperPath = e.target.result;
        Engine.play(passage())
    };
    reader.readAsDataURL(file);
}
PhoneMod.resetWallpaper = function() {
    V.wallpaperPath = undefined
    Engine.play(passage())
}
PhoneMod.toggleBlur = function(checked) {
    V.wallpaperBlur = checked;
};
PhoneMod.toggleDarken = function(checked) {
    V.wallpaperBlack = checked;
};


// ================== passage 注入 ==================
$(document).on(":passagerender", function (ev) {
  PhoneMod.PhoneUIInit(ev);

  PhoneMod.events.forEach(function(event) {
    if (V.passage === event.passage) {
      if (event.chance === undefined || Math.random() < event.chance) {
        const $target = $(ev.content).find(`a[data-passage="${event.target}"]`);
        if ($target.length > 0) {
            if (event.goto === true) {
              new Wikifier(null, `<<goto "${event.event}">>`);
            } else {
              const Div = document.createElement("div");
              Div.style.display = "inline";
              new Wikifier(Div, `<<include "${event.event}">>`);
              if (event.position === "before") {
                $target.first().before(Div);
              } else if (event.position === "after") {
                $target.first().after(Div);
              } else if (event.position === "replace") {
                $target.first().replaceWith(Div);
              }
            }
        }
        if (event.replace_target) {
          const $replaceTarget = $(ev.content).find(`a[data-passage="${event.replace_target}"]`);
          if ($replaceTarget.length > 0) {
            const Div = document.createElement("div");
            Div.style.display = "inline";
            new Wikifier(Div, `<<include "${event.replace_event}">>`);
            $replaceTarget.first().replaceWith(Div);
          }
        }
  }}})
});
$(document).one(":passageinit", function () {
  OnMacro("journal", PhoneMod.ShowPhoneJournal)
});


// ================== 游戏内容 ==================
PhoneMod.Phone = class {
  constructor() {
    this.price = undefined;
    this.newness = undefined;
    this.stolen = false;
    this.usable = false
  }

  generate() { // 生成一部手机
    this.price = 4000 + (Math.random() * 3000 - 3000 / 2);
    this.newness = Math.random();
  }

  newBuy(price, newness) {
    this.price = price;
    this.newness = newness;
    this.usable = true
    return this
  }

  newStolen() {
    this.stolen = true;
    this.generate()
    return this
  }
}

PhoneMod.BuyPhone = function(price) { // 购买一部手机
  V.PhoneOwned = V.PhoneOwned || []
  V.PhoneOwned.push(new PhoneMod.Phone().newBuy(price, 1));
}
PhoneMod.BuySecondPhone = function(price, newness) { // 购买一部二手手机
  V.PhoneOwned = V.PhoneOwned || []
  V.PhoneOwned.push(new PhoneMod.Phone().newBuy(price, newness));
}
PhoneMod.StolePhone = function() { // 盗窃一部手机
  V.PhoneOwned = V.PhoneOwned || []
  V.PhoneOwned.push(new PhoneMod.Phone().newStolen());
}

PhoneMod.ShowPhoneJournal = function() {
  if (V.PhoneOwned) {
    const Uls = document.getElementsByClassName("journal carry")
    if (Uls.length > 0) {
      let Ul = Uls[0];
      if (Uls.length > 1) Ul = Uls[1];
      const Li = document.createElement("li");
      new Wikifier(Li, `<<icon "phone/phones.png">> <span class="yellow">持有的手机</span>。可以出售给手机店。`);
      Ul.appendChild(Li);
      V.PhoneOwned.forEach(function(phone) {
        const Li = document.createElement("li");
        let info = PhoneMod.getPhoneConditionInfo(phone.newness);
        new Wikifier(Li, `<span style="margin-right: 50px"></span><<icon "phone/phone.png">>
          一部
          <span style='color: ${info.color}'>${info.text}</span>
          的手机，官网售价为
          <span class='gold'>£${Math.round(phone.price)}</span>。
          <<if ${phone.stolen}>>
            <span class='red'>盗窃得来</span>
            <<if ${phone.usable}>>
              <span class='yellow'密码已重置</span>
            <<else>>
              <span class='red'>因为密码未知而无法使用</span>
            <</if>>
          <<else>>
            <span class='green'>官方渠道购买</span>
          <</if>>`);
        Ul.appendChild(Li)
      })
  }}
}; 